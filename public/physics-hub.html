<!DOCTYPE html>
<html lang="zh-CN" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Hub - åŒ—äº¬å¤§å­¦ç‰©ç†å­¦é™¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #ffffff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .post-content, .comment-content {
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="h-full antialiased">

    <div id="app-wrapper" class="min-h-full flex flex-col">

        <header class="bg-gray-800 shadow sticky top-0 z-10">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 class="text-xl font-bold text-white">
                    <i class="fas fa-atom text-blue-400 mr-2"></i>Physics Hub - åŒ—äº¬å¤§å­¦ç‰©ç†å­¦é™¢
                </h1>
                <div id="header-auth-section" class="flex items-center space-x-4">
                    <span id="auth-status" class="text-sm text-gray-400">Loading...</span>
                    
                    <div id="anon-toggle-container" class="flex items-center bg-gray-700 p-1 rounded-full hidden">
                        <input type="checkbox" id="anon-toggle" class="hidden" checked>
                        <label for="anon-toggle" id="anon-label" class="cursor-pointer select-none text-xs font-medium text-gray-400 px-3 py-1 rounded-full transition-colors duration-200" title="Toggle posting anonymity">
                            åŒ¿åå‘å¸ƒ
                        </label>
                    </div>

                    <button id="sign-out-button" class="bg-red-600 text-white px-3 py-1 rounded-lg text-sm font-medium hover:bg-red-700 transition-colors duration-150 hidden">
                        <i class="fas fa-sign-out-alt"></i> é€€å‡ºç™»å½•
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-grow max-w-7xl mx-auto w-full p-4 sm:p-6 lg:p-8">

            <div id="initial-loading" class="flex flex-col items-center justify-center h-64 text-white hidden">
                <div class="spinner"></div>
                <p class="mt-4 text-gray-300">æ­£åœ¨åˆå§‹åŒ– Physics Hub...</p>
            </div>
            
            <div id="initial-error" class="hidden p-4 bg-red-800 text-white rounded-lg border border-red-600" role="alert">
                <p class="font-bold">åˆå§‹åŒ–é”™è¯¯</p>
                <p id="error-message"></p>
            </div>
            
            <div id="login-screen" class="max-w-md mx-auto mt-10 p-6 bg-gray-800 rounded-xl shadow-2xl space-y-4 hidden">
                <h2 class="text-2xl font-semibold text-white text-center mb-4">è¯¾ç¨‹ä¸­å¿ƒç™»å½•</h2>
                <div class="p-3 bg-blue-900 text-blue-200 text-sm rounded-lg">
                    <p class="font-bold">æ¼”ç¤ºè¯´æ˜:</p>
                    <p>ç”¨æˆ·IDä¸º 1 åˆ° 100ã€‚é»˜è®¤å¯†ç ä¸º `<span class="font-mono bg-blue-800 px-1 rounded">111111</span>`ã€‚</p>
                    <p>åŠ©æ•™IDä¸º `<span class="font-mono bg-blue-800 px-1 rounded">1</span>`ï¼Œå¯†ç ä¸º `<span class="font-mono bg-blue-800 px-1 rounded">111111</span>`ã€‚</p>
                </div>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-id" class="block text-sm font-medium text-gray-300">ç”¨æˆ· ID (1-100)</label>
                        <input type="number" id="login-id" required min="1" max="100" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm p-3 text-white placeholder-gray-400 focus:border-blue-500 focus:ring-blue-500" placeholder="ä¾‹å¦‚: 42">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-300">å¯†ç </label>
                        <input type="password" id="login-password" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm p-3 text-white placeholder-gray-400 focus:border-blue-500 focus:ring-blue-500" placeholder="é»˜è®¤å¯†ç ä¸º 111111">
                    </div>
                    <button type="submit" id="login-button" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors duration-150">
                        <i class="fas fa-sign-in-alt mr-2"></i> ç™»å½•
                    </button>
                     <p id="login-error-message" class="text-sm text-red-400 mt-2 text-center hidden"></p>
                </form>
            </div>
            
            <div id="app-content" class="hidden">
                
                <div class="bg-gray-800 p-3 rounded-lg shadow mb-6 flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <label for="course-select" class="text-gray-300 text-sm font-medium">å½“å‰è¯¾ç¨‹:</label>
                        <select id="course-select" class="bg-gray-700 text-white p-2 rounded text-sm focus:ring-blue-500 focus:border-blue-500 min-w-[200px]">
                            <!-- è¯¾ç¨‹é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                        </select>
                    </div>
                    <button id="show-new-course-modal" class="bg-purple-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-purple-700 transition-colors duration-150 hidden">
                        <i class="fas fa-plus mr-1"></i> æ–°å»ºè¯¾ç¨‹
                    </button>
                </div>

                <nav class="flex space-x-4 border-b border-gray-700 mb-6">
                    <button data-tab="forum" class="tab-button px-3 py-2 text-sm font-medium rounded-t-lg bg-blue-600 text-white transition-colors duration-150">
                        <i class="fas fa-comments mr-1"></i>å…¬å…±è®¨è®ºåŒº
                    </button>
                    <button data-tab="repo" class="tab-button px-3 py-2 text-sm font-medium rounded-t-lg text-gray-400 hover:text-white transition-colors duration-150">
                        <i class="fas fa-folder-open mr-1"></i>è¯¾ç¨‹èµ„æ–™
                    </button>
                    <button data-tab="profile" class="tab-button px-3 py-2 text-sm font-medium rounded-t-lg text-gray-400 hover:text-white transition-colors duration-150">
                        <i class="fas fa-user-circle mr-1"></i>ä¸ªäººèµ„æ–™ä¸å®‰å…¨
                    </button>
                    <button data-tab="review" id="review-tab" class="tab-button px-3 py-2 text-sm font-medium rounded-t-lg text-yellow-400 hover:text-white transition-colors duration-150 hidden">
                         <i class="fas fa-exclamation-triangle mr-1"></i>å®¡æ ¸é˜Ÿåˆ—
                    </button>
                </nav>

                <div id="tab-forum" class="tab-content">
                    <h2 class="text-2xl font-semibold text-white mb-4">è¯¾ç¨‹é—®ç­”è®¨è®º</h2>
                    
                    <div class="bg-gray-800 p-4 rounded-lg shadow mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <select id="post-filter" class="bg-gray-700 text-white p-2 rounded text-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="Question">é—®é¢˜</option>
                                <option value="Announcement">å…¬å‘Š</option>
                                <option value="All">å…¨éƒ¨å¸–å­</option>
                            </select>
                            <button id="show-forum-post-modal" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors duration-150">
                                <i class="fas fa-plus mr-1"></i> æ–°å»ºé—®ç­”å¸–å­
                            </button>
                        </div>
                        
                        <div id="post-list" class="space-y-4">
                            <!-- å¸–å­åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                        </div>

                         <div id="post-empty-state" class="text-center py-10 text-gray-400 hidden">
                            <i class="fas fa-box-open fa-2x mb-3"></i>
                            <p>æš‚æ— åŒ¹é…ç­›é€‰æ¡ä»¶çš„å¸–å­ã€‚æˆä¸ºç¬¬ä¸€ä¸ªå‘èµ·è®¨è®ºçš„äººï¼</p>
                        </div>

                    </div>
                </div>

                <div id="tab-repo" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold text-white mb-4">å®˜æ–¹è¯¾ç¨‹èµ„æ–™åº“</h2>
                    
                    <div class="flex justify-end mb-4">
                        <button id="show-repo-post-modal" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors duration-150 hidden">
                            <i class="fas fa-upload mr-1"></i> ä¸Šä¼ æ–°èµ„æ–™
                        </button>
                    </div>

                    <div id="repo-list" class="space-y-4 bg-gray-800 p-4 rounded-lg shadow">
                         <p class="text-gray-400">æ­£åœ¨åŠ è½½èµ„æ–™...</p>
                    </div>
                </div>

                <div id="tab-profile" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold text-white mb-4">ä¸ªäººèµ„æ–™ä¸å®‰å…¨è®¾ç½®</h2>
                    <div class="bg-gray-800 p-6 rounded-lg shadow max-w-lg">
                        <div class="border-b border-gray-700 pb-4 mb-4">
                            <h3 class="text-xl text-white font-semibold mb-3">è´¦æˆ·ä¿¡æ¯</h3>
                            <form id="profile-form" class="space-y-4">
                                <div>
                                    <label for="display-name" class="block text-sm font-medium text-gray-300">æ˜¾ç¤ºåç§°</label>
                                    <input type="text" id="display-name" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm p-2 text-white placeholder-gray-400 focus:border-blue-500 focus:ring-blue-500">
                                    <p class="mt-1 text-xs text-gray-500">æ­¤åç§°å°†æ˜¾ç¤ºåœ¨æ‚¨çš„å…¬å¼€å¸–å­ä¸­ã€‚</p>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-sm font-medium text-gray-300">æ‚¨çš„ç”¨æˆ·ID:</p>
                                        <span id="profile-user-id" class="font-bold text-lg text-blue-400"></span>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-300">æ‚¨çš„è§’è‰²:</p>
                                        <span id="current-role" class="font-bold text-lg text-yellow-400"></span>
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors duration-150">
                                    ä¿å­˜æ˜¾ç¤ºåç§°
                                </button>
                            </form>
                        </div>

                        <div>
                             <h3 class="text-xl text-white font-semibold mb-3">å¯†ç æ›´æ–°</h3>
                             <form id="password-form" class="space-y-4">
                                <div>
                                    <label for="current-password" class="block text-sm font-medium text-gray-300">å½“å‰å¯†ç </label>
                                    <input type="password" id="current-password" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm p-2 text-white focus:border-red-500 focus:ring-red-500">
                                </div>
                                <div>
                                    <label for="new-password" class="block text-sm font-medium text-gray-300">æ–°å¯†ç  (è‡³å°‘6ä½)</label>
                                    <input type="password" id="new-password" required minlength="6" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm p-2 text-white focus:border-red-500 focus:ring-red-500">
                                </div>
                                <div>
                                    <label for="confirm-password" class="block text-sm font-medium text-gray-300">ç¡®è®¤æ–°å¯†ç </label>
                                    <input type="password" id="confirm-password" required minlength="6" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm p-2 text-white focus:border-red-500 focus:ring-red-500">
                                </div>
                                <button type="submit" id="update-password-button" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition-colors duration-150">
                                    æ›´æ–°å¯†ç 
                                </button>
                                <p id="password-message" class="text-sm text-green-400 mt-2 hidden"></p>
                             </form>
                        </div>
                    </div>
                </div>

                 <div id="tab-review" class="tab-content hidden">
                    <h2 class="text-2xl font-semibold text-white mb-4">å†…å®¹å®¡æ ¸é˜Ÿåˆ—</h2>
                     <div id="review-list" class="space-y-4 bg-gray-800 p-4 rounded-lg shadow">
                         <p class="text-gray-400">æš‚æ— å¾…å®¡æ ¸å†…å®¹ã€‚</p>
                     </div>
                </div>

            </div>
        </main>
        
        <div id="post-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-20 hidden">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-lg">
                <h3 class="text-xl font-semibold text-white mb-4">åˆ›å»ºæ–°å¸–å­</h3>
                <form id="new-post-form" class="space-y-4">
                    <div>
                        <label for="post-type" class="block text-sm font-medium text-gray-300">å¸–å­ç±»å‹</label>
                        <select id="post-type" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm p-2 text-white focus:border-blue-500 focus:ring-blue-500">
                            <option value="Question">é—®é¢˜ (é—®ç­”)</option>
                            <option value="Announcement">å…¬å‘Š (ä»…é™åŠ©æ•™/æ•™å¸ˆ)</option>
                            <option value="Material">èµ„æ–™/æ–‡ä»¶ (ä»…é™åŠ©æ•™/æ•™å¸ˆ)</option>
                        </select>
                    </div>
                     <div>
                        <label for="post-title" class="block text-sm font-medium text-gray-300">æ ‡é¢˜</label>
                        <input type="text" id="post-title" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm p-2 text-white placeholder-gray-400 focus:border-blue-500 focus:ring-blue-500" placeholder="å¸–å­çš„ç®€æ˜æ ‡é¢˜">
                    </div>
                    <div>
                        <label for="post-content-input" class="block text-sm font-medium text-gray-300">å†…å®¹</label>
                        <textarea id="post-content-input" rows="4" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm p-2 text-white placeholder-gray-400 focus:border-blue-500 focus:ring-blue-500" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–è¯¦ç»†æè¿°..."></textarea>
                    </div>
                    
                    <div id="file-upload-section" class="hidden">
                         <label for="file-upload" class="block text-sm font-medium text-gray-300">æ–‡ä»¶é™„ä»¶ (PDF, JPG, PNG)</label>
                         <input type="file" id="file-upload" accept=".pdf,.jpg,.jpeg,.png" class="mt-1 block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                         <p id="file-status" class="mt-1 text-xs text-gray-500"></p>
                    </div>

                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-post-modal" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-gray-700 transition-colors duration-150">å–æ¶ˆ</button>
                        <button type="submit" id="submit-post-button" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors duration-150">
                            å‘å¸ƒ
                        </button>
                    </div>
                     <p id="post-error-message" class="text-sm text-red-400 mt-2 hidden"></p>
                </form>
            </div>
        </div>

        <div id="comment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-20 hidden">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-lg">
                <h3 class="text-xl font-semibold text-white mb-4">å‘å¸ƒè¯„è®º/å›ç­”</h3>
                <form id="new-comment-form" class="space-y-4">
                    <input type="hidden" id="comment-post-id">
                    <div>
                        <label for="comment-content-input" class="block text-sm font-medium text-gray-300">æ‚¨çš„å›ç­”</label>
                        <textarea id="comment-content-input" rows="3" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm p-2 text-white placeholder-gray-400 focus:border-blue-500 focus:ring-blue-500" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„ç­”æ¡ˆæˆ–è¯„è®º..."></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-comment-modal" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-gray-700 transition-colors duration-150">å–æ¶ˆ</button>
                        <button type="submit" id="submit-comment-button" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors duration-150">
                            æäº¤ç­”æ¡ˆ
                        </button>
                    </div>
                     <p id="comment-error-message" class="text-sm text-red-400 mt-2 hidden"></p>
                </form>
            </div>
        </div>
        
        <div id="new-course-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-20 hidden">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-semibold text-white mb-4">åˆ›å»ºæ–°è¯¾ç¨‹èµ„æ–™åº“</h3>
                <form id="new-course-form" class="space-y-4">
                     <div>
                        <label for="course-name-input" class="block text-sm font-medium text-gray-300">è¯¾ç¨‹åç§° (ä¾‹å¦‚: Physics 101)</label>
                        <input type="text" id="course-name-input" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm p-2 text-white placeholder-gray-400 focus:border-purple-500 focus:ring-purple-500" placeholder="ä¾‹å¦‚: PHYC 205: ç»å…¸åŠ›å­¦">
                    </div>
                    <div>
                        <label for="course-description-input" class="block text-sm font-medium text-gray-300">è¯¾ç¨‹æè¿° (å¯é€‰)</label>
                        <textarea id="course-description-input" rows="2" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm p-2 text-white placeholder-gray-400 focus:border-purple-500 focus:ring-purple-500" placeholder="è¯¾ç¨‹ç®€è¦æè¿°..."></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancel-new-course-modal" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-gray-700 transition-colors duration-150">å–æ¶ˆ</button>
                        <button type="submit" id="submit-course-button" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-purple-700 transition-colors duration-150">
                            åˆ›å»ºè¯¾ç¨‹
                        </button>
                    </div>
                     <p id="course-error-message" class="text-sm text-red-400 mt-2 hidden"></p>
                </form>
            </div>
        </div>

    </div>
    
    <script>
        // Physics Hub åº”ç”¨ä¸»é€»è¾‘
        class PhysicsHubApp {
            constructor() {
                // !!! å…³é”®ä¿®å¤ï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„ /apiï¼Œè®© Nginx ä»£ç†å¤„ç† !!!
                this.API_BASE_URL = '/api';
                
                this.app = {
                    user: null,
                    token: localStorage.getItem('authToken'),
                    isTA: false,
                    isAnonPosting: true,
                    currentTab: 'forum',
                    activeCourseId: null,
                    courses: [],
                    posts: [],
                    comments: {},
                    currentPage: 1,
                    postsPerPage: 20,
                    postFilter: 'Question',
                    handlersSetup: false
                };
                
                // DOM å…ƒç´ å¼•ç”¨
                try {
                    this.authStatusEl = document.getElementById('auth-status');
                    this.initialLoadingEl = document.getElementById('initial-loading');
                    this.initialErrorEl = document.getElementById('initial-error');
                    this.errorMessageEl = document.getElementById('error-message');
                    this.loginScreenEl = document.getElementById('login-screen');
                    this.appContentEl = document.getElementById('app-content');
                    this.postListEl = document.getElementById('post-list');
                    this.repoListEl = document.getElementById('repo-list');
                    this.reviewListEl = document.getElementById('review-list');
                    this.postEmptyStateEl = document.getElementById('post-empty-state');
                    this.reviewTabEl = document.getElementById('review-tab');
                    this.postModalEl = document.getElementById('post-modal');
                    this.commentModalEl = document.getElementById('comment-modal');
                    this.fileUploadSectionEl = document.getElementById('file-upload-section');
                    this.postTypeSelect = document.getElementById('post-type');
                    this.anonToggleContainer = document.getElementById('anon-toggle-container');
                    this.anonToggle = document.getElementById('anon-toggle');
                    this.anonLabel = document.getElementById('anon-label');
                    this.signOutButton = document.getElementById('sign-out-button');
                    this.courseSelectEl = document.getElementById('course-select');
                    this.showNewCourseModalEl = document.getElementById('show-new-course-modal');
                    this.newCourseModalEl = document.getElementById('new-course-modal');
                    this.showForumPostModalEl = document.getElementById('show-forum-post-modal');
                    this.showRepoPostModalEl = document.getElementById('show-repo-post-modal');
                    
                    console.log('âœ… DOM å…ƒç´ åˆå§‹åŒ–å®Œæˆ');
                } catch (error) {
                    console.error('âŒ DOM å…ƒç´ åˆå§‹åŒ–å¤±è´¥:', error);
                }
                
                this.init();
            }

            async init() {
                await this.checkAuth();
                this.setupEventListeners();
                
                if (this.app.token) {
                    await this.loadInitialData();
                    this.showAppContent();
                } else {
                    this.showLoginScreen();
                }
            }

            async checkAuth() {
                if (!this.app.token) return;
                
                try {
                    const data = await this.apiCall('/auth/profile');
                    if (data.success) {
                        this.app.user = data.user;
                        this.app.isTA = data.user.role === 'ta';
                    }
                } catch (error) {
                    console.error('âŒ éªŒè¯ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                    this.logout();
                }
            }

            async apiCall(endpoint, options = {}) {
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                if (this.app.token) {
                    headers['Authorization'] = `Bearer ${this.app.token}`;
                }
                
                try {
                    const response = await fetch(`${this.API_BASE_URL}${endpoint}`, {
                        ...options,
                        headers
                    });
                    
                    if (response.status === 401) {
                        this.logout();
                        throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    }
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
                    }
                    
                    return data;
                } catch (error) {
                    console.error('âŒ APIè°ƒç”¨é”™è¯¯:', error);
                    throw error;
                }
            }

            async login(userId, password) {
                try {
                    const data = await this.apiCall('/auth/login', {
                        method: 'POST',
                        body: JSON.stringify({ userId, password })
                    });
                    
                    if (data.success) {
                        this.app.token = data.token;
                        this.app.user = data.user;
                        this.app.isTA = data.user.role === 'ta';
                        localStorage.setItem('authToken', data.token);
                        
                        await this.loadInitialData();
                        this.showAppContent();
                        
                        return true;
                    }
                    return false;
                } catch (error) {
                    throw error;
                }
            }

            logout() {
                this.app.token = null;
                this.app.user = null;
                this.app.isTA = false;
                localStorage.removeItem('authToken');
                this.showLoginScreen();
            }

            async loadInitialData() {
                try {
                    // åŠ è½½è¯¾ç¨‹
                    const coursesData = await this.apiCall('/courses');
                    this.app.courses = coursesData.courses;
                    
                    console.log('ğŸ“š åŠ è½½çš„è¯¾ç¨‹:', this.app.courses);
                    
                    // å…³é”®ä¿®å¤ï¼šç¡®ä¿è®¾ç½®é»˜è®¤è¯¾ç¨‹
                    if (this.app.courses.length > 0) {
                        if (!this.app.activeCourseId) {
                            this.app.activeCourseId = this.app.courses[0].id;
                            console.log(`ğŸ¯ è®¾ç½®é»˜è®¤è¯¾ç¨‹ID: ${this.app.activeCourseId}`);
                        }
                        // æ›´æ–°è¯¾ç¨‹é€‰æ‹©æ¡†
                        this.updateCourseSelect();
                    } else if (this.app.isTA) {
                        // å¦‚æœæ˜¯TAä¸”æ²¡æœ‰è¯¾ç¨‹ï¼Œæ˜¾ç¤ºåˆ›å»ºè¯¾ç¨‹æç¤º
                        console.log('âš ï¸ æ²¡æœ‰å¯ç”¨è¯¾ç¨‹ï¼ŒTAå¯ä»¥åˆ›å»ºæ–°è¯¾ç¨‹');
                    }
                    
                    // åŠ è½½å¸–å­
                    await this.loadPosts();
                    
                } catch (error) {
                    console.error('âŒ åŠ è½½åˆå§‹æ•°æ®å¤±è´¥:', error);
                    this.showError('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
                }
            }

            updateCourseSelect() {
                if (!this.courseSelectEl) {
                    console.error('âŒ è¯¾ç¨‹é€‰æ‹©å™¨DOMå…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }
                
                this.courseSelectEl.innerHTML = '';
                
                if (this.app.courses.length === 0) {
                    this.courseSelectEl.innerHTML = '<option value="">æš‚æ— è¯¾ç¨‹</option>';
                    console.log('âš ï¸ æ²¡æœ‰è¯¾ç¨‹å¯æ˜¾ç¤º');
                    return;
                }
                
                this.app.courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.id;
                    option.textContent = course.name;
                    option.selected = course.id === this.app.activeCourseId;
                    this.courseSelectEl.appendChild(option);
                });
                
                console.log(`âœ… æ›´æ–°è¯¾ç¨‹é€‰æ‹©æ¡†ï¼Œæ´»è·ƒè¯¾ç¨‹ID: ${this.app.activeCourseId}, è¯¾ç¨‹æ•°é‡: ${this.app.courses.length}`);
            }

            async loadPosts() {
                console.log('ğŸ”„ å¼€å§‹åŠ è½½å¸–å­ï¼Œæ´»è·ƒè¯¾ç¨‹ID:', this.app.activeCourseId);
                
                // å¦‚æœæ²¡æœ‰æ´»è·ƒè¯¾ç¨‹ä½†æœ‰è¯¾ç¨‹åˆ—è¡¨ï¼Œè®¾ç½®ç¬¬ä¸€ä¸ªè¯¾ç¨‹ä¸ºæ´»è·ƒè¯¾ç¨‹
                if (!this.app.activeCourseId && this.app.courses.length > 0) {
                    this.app.activeCourseId = this.app.courses[0].id;
                    console.log(`ğŸ¯ è‡ªåŠ¨è®¾ç½®æ´»è·ƒè¯¾ç¨‹ä¸º: ${this.app.activeCourseId}`);
                }
                
                // å¦‚æœæ²¡æœ‰è¯¾ç¨‹ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                if (!this.app.activeCourseId && this.app.courses.length === 0) {
                    console.log('âš ï¸ æ²¡æœ‰å¯ç”¨è¯¾ç¨‹ï¼Œæ— æ³•åŠ è½½å¸–å­');
                    this.showNoCoursesMessage();
                    return;
                }
                
                try {
                    const params = new URLSearchParams({
                        page: this.app.currentPage,
                        limit: this.app.postsPerPage
                    });
                    
                    // å…³é”®ä¿®å¤ï¼šå§‹ç»ˆä¼ é€’ courseId
                    if (this.app.activeCourseId) {
                        params.append('courseId', this.app.activeCourseId);
                        console.log(`ğŸ” è¯·æ±‚å¸–å­ï¼Œè¯¾ç¨‹ID: ${this.app.activeCourseId}`);
                    }
                    
                    if (this.app.postFilter && this.app.postFilter !== 'All') {
                        params.append('type', this.app.postFilter);
                    }
                    
                    const data = await this.apiCall(`/posts?${params}`);
                    this.app.posts = data.posts;
                    
                    console.log(`âœ… æˆåŠŸåŠ è½½ ${this.app.posts.length} ä¸ªå¸–å­`);
                    
                    // æ ¹æ®å½“å‰æ ‡ç­¾é¡µæ¸²æŸ“å¸–å­
                    if (this.app.currentTab === 'forum' && this.postListEl) {
                        this.renderPosts(this.postListEl, ['Question', 'Announcement']);
                    } else if (this.app.currentTab === 'repo' && this.repoListEl) {
                        this.renderPosts(this.repoListEl, ['Material']);
                    }
                    
                } catch (error) {
                    console.error('âŒ åŠ è½½å¸–å­å¤±è´¥:', error);
                    this.showError('åŠ è½½å¸–å­å¤±è´¥: ' + error.message);
                }
            }

            async loadComments(postId, courseId) {
                try {
                    const data = await this.apiCall(`/comments/post/${postId}`);
                    const key = `${courseId}_${postId}`;
                    this.app.comments[key] = data.comments || [];
                    this.renderComments(postId, courseId);
                } catch (error) {
                    console.error(`âŒ åŠ è½½è¯„è®ºå¤±è´¥ (å¸–å­ ${postId}):`, error);
                }
            }

            async loadReviewQueue() {
                if (!this.app.isTA) return;
                
                try {
                    // åŠ è½½å¾…å®¡æ ¸å¸–å­
                    const postsData = await this.apiCall('/posts/moderation/pending');
                    
                    // åŠ è½½å¾…å®¡æ ¸è¯„è®º
                    const commentsData = await this.apiCall('/comments/moderation/pending');
                    
                    this.renderReviewQueue(postsData.posts, commentsData.comments);
                    
                } catch (error) {
                    console.error('âŒ åŠ è½½å®¡æ ¸é˜Ÿåˆ—å¤±è´¥:', error);
                    this.showError('åŠ è½½å®¡æ ¸é˜Ÿåˆ—å¤±è´¥: ' + error.message);
                }
            }

            renderApp() {
                if (!this.app.user) {
                    // æœªç™»å½•çŠ¶æ€
                    this.anonToggleContainer.classList.add('hidden');
                    this.signOutButton.classList.add('hidden');
                    this.authStatusEl.textContent = 'è¯·ç™»å½•ã€‚';
                    return;
                }

                // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                const displayId = this.app.user.email.split('@')[0].replace('user', '');
                this.authStatusEl.textContent = `ç™»å½•ç”¨æˆ·: ${this.app.user.displayName} ${this.app.isTA ? '(åŠ©æ•™)' : ''} | ç”¨æˆ·ID: ${displayId}`;
                this.anonToggleContainer.classList.remove('hidden');
                this.signOutButton.classList.remove('hidden');
                
                // å…³é”®ä¿®æ”¹ï¼šæ›´æ–°è¯¾ç¨‹é€‰æ‹©æ¡†
                this.updateCourseSelect();

                // åˆ‡æ¢åŠ©æ•™ä¸“å±UI
                this.reviewTabEl.classList.toggle('hidden', !this.app.isTA);
                this.showNewCourseModalEl.classList.toggle('hidden', !this.app.isTA);
                
                // æ›´æ–°åŒ¿åå‘å¸ƒå¼€å…³
                this.anonToggle.checked = this.app.isAnonPosting;
                this.anonLabel.textContent = this.app.isAnonPosting ? 'åŒ¿åå‘å¸ƒ' : `ä»¥ ${this.app.user.displayName} å‘å¸ƒ`;
                this.anonLabel.classList.toggle('bg-gray-600', this.app.isAnonPosting);
                this.anonLabel.classList.toggle('bg-green-600', !this.app.isAnonPosting);

                // æ¸²æŸ“å½“å‰æ ‡ç­¾é¡µå†…å®¹
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                document.getElementById(`tab-${this.app.currentTab}`).classList.remove('hidden');
                
                // æ›´æ–°æ ‡ç­¾æŒ‰é’®è§†è§‰çŠ¶æ€
                document.querySelectorAll('.tab-button').forEach(btn => {
                    const isActive = btn.dataset.tab === this.app.currentTab;
                    btn.classList.toggle('bg-blue-600', isActive);
                    btn.classList.toggle('text-white', isActive);
                    btn.classList.toggle('text-gray-400', !isActive);
                    btn.classList.toggle('hover:text-white', !isActive);
                });
                
                // æ ¹æ®å½“å‰æ ‡ç­¾é¡µæ˜¾ç¤ºç›¸åº”çš„å†…å®¹å’ŒæŒ‰é’®
                if (this.app.courses.length > 0) {
                    if (this.app.currentTab === 'forum') {
                        this.showForumPostModalEl.classList.remove('hidden');
                        this.showRepoPostModalEl.classList.add('hidden');
                        if (this.postListEl) {
                            this.renderPosts(this.postListEl, ['Question', 'Announcement']);
                        }
                    } else if (this.app.currentTab === 'repo') {
                        this.showForumPostModalEl.classList.add('hidden');
                        this.showRepoPostModalEl.classList.toggle('hidden', !this.app.isTA);
                        if (this.repoListEl) {
                            this.renderPosts(this.repoListEl, ['Material']);
                        }
                    } else if (this.app.currentTab === 'review') {
                        this.showForumPostModalEl.classList.add('hidden');
                        this.showRepoPostModalEl.classList.add('hidden');
                        this.loadReviewQueue();
                    }
                } else {
                    // æ²¡æœ‰è¯¾ç¨‹æ—¶çš„æç¤º
                    this.showNoCoursesMessage();
                }
                
                // æ¸²æŸ“ä¸ªäººèµ„æ–™æ•°æ®
                if (document.getElementById('display-name')) {
                    document.getElementById('display-name').value = this.app.user?.displayName || '';
                    document.getElementById('current-role').textContent = this.app.user?.role.toUpperCase() || 'æœªçŸ¥';
                    document.getElementById('profile-user-id').textContent = displayId || 'æœªçŸ¥';
                }
                
                // æ ¹æ®æ¨¡æ€æ¡†ä¸­çš„å¸–å­ç±»å‹æ˜¾ç¤º/éšè—æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
                if (this.postTypeSelect && this.postTypeSelect.value === 'Material' && this.app.isTA) {
                    this.fileUploadSectionEl.classList.remove('hidden');
                } else if (this.fileUploadSectionEl) {
                    this.fileUploadSectionEl.classList.add('hidden');
                }
            }

            showNoCoursesMessage() {
                const forumMessage = this.app.isTA ? 
                    "æš‚æ— è¯¾ç¨‹ã€‚è¯·åˆ›å»ºç¬¬ä¸€ä¸ªè¯¾ç¨‹ä»¥å¼€å§‹ä½¿ç”¨ã€‚" : 
                    "æš‚æ— å¯ç”¨è¯¾ç¨‹ã€‚è¯·è”ç³»åŠ©æ•™åˆ›å»ºè¯¾ç¨‹ã€‚";
                
                const repoMessage = this.app.isTA ? 
                    "æš‚æ— è¯¾ç¨‹ã€‚è¯·åˆ›å»ºè¯¾ç¨‹ä»¥ä¸Šä¼ èµ„æ–™ã€‚" : 
                    "æš‚æ— å¯ç”¨è¯¾ç¨‹ã€‚è¯·è”ç³»åŠ©æ•™åˆ›å»ºè¯¾ç¨‹ã€‚";
                
                if (this.postListEl) {
                    this.postListEl.innerHTML = `<div class="text-center py-10 text-gray-400">
                        <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
                        <p>${forumMessage}</p>
                        ${this.app.isTA ? '<button id="create-first-course" class="mt-4 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">åˆ›å»ºç¬¬ä¸€ä¸ªè¯¾ç¨‹</button>' : ''}
                    </div>`;
                    
                    if (this.app.isTA) {
                        document.getElementById('create-first-course')?.addEventListener('click', () => {
                            this.newCourseModalEl.classList.remove('hidden');
                        });
                    }
                }
                
                if (this.repoListEl) {
                    this.repoListEl.innerHTML = `<div class="text-center py-10 text-gray-400">
                        <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
                        <p>${repoMessage}</p>
                    </div>`;
                }
            }

            renderPosts(container, types) {
                // æ·»åŠ å®¹å™¨æ£€æŸ¥
                if (!container) {
                    console.error('âŒ æ¸²æŸ“å®¹å™¨æœªå®šä¹‰:', container, types);
                    return;
                }
                
                if (!this.app.posts) return;

                // æ ¹æ®å®¹å™¨ç¡®å®šç­›é€‰æ¡ä»¶
                const filterType = container === this.postListEl ? 
                    (document.getElementById('post-filter')?.value || 'All') : 'All';

                // å…³é”®ä¿®å¤ï¼šæ­£ç¡®è¿‡æ»¤å®¡æ ¸çŠ¶æ€
                const filteredPosts = this.app.posts.filter(post => 
                    (types.includes(post.type)) && 
                    (filterType === 'All' || post.type === filterType) &&
                    // å¯¹äºå­¦ç”Ÿï¼Œåªæ˜¾ç¤ºå·²å‘å¸ƒçš„å¸–å­ï¼›å¯¹äºTAï¼Œæ˜¾ç¤ºæ‰€æœ‰å¸–å­
                    (this.app.isTA || post.status === 'Published') &&
                    // å¯¹äºå­¦ç”Ÿï¼Œåªæ˜¾ç¤ºæ´»è·ƒè¯¾ç¨‹çš„å¸–å­ï¼›å¯¹äºTAï¼Œæ˜¾ç¤ºæ‰€æœ‰
                    (this.app.isTA || post.course_id === this.app.activeCourseId)
                ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                container.innerHTML = '';
                
                if (filteredPosts.length === 0) {
                    // èµ„æ–™åˆ—è¡¨çš„ç‰¹æ®Šç©ºçŠ¶æ€
                    container.innerHTML = `<div class="text-center py-10 text-gray-400">
                        <i class="fas fa-box-open fa-2x mb-3"></i>
                        <p>${container === this.postListEl ? 'æš‚æ— åŒ¹é…ç­›é€‰æ¡ä»¶çš„å¸–å­ã€‚' : this.app.isTA ? 'ä¸Šä¼ ç¬¬ä¸€ä¸ªèµ„æ–™åˆ°è¯¾ç¨‹èµ„æ–™åº“ã€‚' : 'æš‚æ— å®˜æ–¹èµ„æ–™ä¸Šä¼ ã€‚'}</p>
                    </div>`;
                } else {
                    filteredPosts.forEach(post => {
                        const postEl = this.createPostElement(post);
                        container.appendChild(postEl);
                        this.loadComments(post.id, post.course_id);
                    });
                }
            }

            renderComments(postId, courseId) {
                const key = `${courseId}_${postId}`;
                const commentContainer = document.getElementById(`comments-${postId}`);
                if (!commentContainer) return;
                
                // å…³é”®ä¿®å¤ï¼šåªæ˜¾ç¤ºå·²å‘å¸ƒçš„è¯„è®º
                const comments = (this.app.comments[key] || []).filter(comment => 
                    this.app.isTA || comment.status === 'Published'
                );
                commentContainer.innerHTML = '';

                comments.forEach(comment => {
                    const commentEl = document.createElement('div');
                    commentEl.className = 'p-3 bg-gray-600 rounded-lg border-l-2 border-green-400 relative';
                    
                    const isAnon = comment.visibility === 'Anonymous';
                    const displayName = isAnon ? 'åŒ¿åå›å¤è€…' : comment.author_name;

                    // æ·»åŠ å®¡æ ¸çŠ¶æ€æ ‡è®°
                    const statusBadge = comment.status === 'PendingReview' ? 
                        `<span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-yellow-500 text-white ml-2">
                            <i class="fas fa-clock mr-1"></i>å®¡æ ¸ä¸­
                        </span>` : '';

                    commentEl.innerHTML = `
                        <div class="flex justify-between items-start mb-1">
                            <p class="text-sm font-medium text-white">
                                <i class="fas fa-reply-all mr-1 text-green-400"></i> ${displayName} 
                                ${statusBadge}
                                <span class="text-xs text-gray-400 ml-2">(${new Date(comment.timestamp).toLocaleTimeString()})</span>
                            </p>
                            ${this.app.isTA ? `
                                <button data-post-id="${postId}" data-comment-id="${comment.id}" data-course-id="${courseId}" class="delete-comment-button text-red-400 hover:text-red-300 text-sm" title="åˆ é™¤è¯„è®º">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            ` : ''}
                        </div>
                        <p class="text-gray-300 text-sm comment-content">${comment.content}</p>
                    `;
                    commentContainer.appendChild(commentEl);
                    
                    // ä¸ºåŠ©æ•™æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
                    if (this.app.isTA) {
                        commentEl.querySelector('.delete-comment-button').addEventListener('click', (e) => this.handleDeleteComment(e));
                    }
                });
            }

            /**
             * æ¸²æŸ“å®¡æ ¸é˜Ÿåˆ—
             */
            renderReviewQueue(posts = [], comments = []) {
                if (!this.reviewListEl) return;
                
                this.reviewListEl.innerHTML = '';
                
                const allPendingItems = [];
                
                // å¤„ç†å¾…å®¡æ ¸å¸–å­
                posts.forEach(post => {
                    allPendingItems.push({
                        type: 'post',
                        id: post.id,
                        title: post.title,
                        content: post.content,
                        authorId: post.author_id,
                        authorName: post.author_name,
                        timestamp: post.timestamp,
                        courseId: post.course_id,
                        courseName: post.course_name || 'æœªçŸ¥è¯¾ç¨‹',
                        status: post.status
                    });
                });
                
                // å¤„ç†å¾…å®¡æ ¸è¯„è®º
                comments.forEach(comment => {
                    allPendingItems.push({
                        type: 'comment',
                        id: comment.id,
                        postId: comment.post_id,
                        postTitle: comment.post_title || 'æœªçŸ¥å¸–å­',
                        content: comment.content,
                        authorId: comment.author_id,
                        authorName: comment.author_name,
                        timestamp: comment.timestamp,
                        courseId: comment.course_id,
                        courseName: comment.course_name || 'æœªçŸ¥è¯¾ç¨‹',
                        status: comment.status
                    });
                });
                
                // æŒ‰æ—¶é—´æ’åº
                allPendingItems.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                if (allPendingItems.length === 0) {
                    this.reviewListEl.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-check-circle text-4xl mb-4"></i>
                            <p class="text-lg">æš‚æ— å¾…å®¡æ ¸å†…å®¹</p>
                            <p class="text-sm mt-2">æ‰€æœ‰å†…å®¹éƒ½å·²å®¡æ ¸å®Œæ¯•</p>
                        </div>
                    `;
                    return;
                }
                
                allPendingItems.forEach(item => {
                    const itemElement = this.createReviewItemElement(item);
                    this.reviewListEl.appendChild(itemElement);
                });
            }

            /**
             * åˆ›å»ºå®¡æ ¸é¡¹ç›®å…ƒç´ 
             */
            createReviewItemElement(item) {
                const isPost = item.type === 'post';
                const itemDiv = document.createElement('div');
                itemDiv.className = 'bg-yellow-900 border-l-4 border-yellow-500 rounded-lg p-4 mb-4 shadow-md';
                
                const timeAgo = this.formatTimeAgo(item.timestamp);
                
                itemDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center space-x-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-500 text-white">
                                <i class="fas ${isPost ? 'fa-file-alt' : 'fa-comment'} mr-1"></i>
                                ${isPost ? 'å¸–å­' : 'è¯„è®º'}
                            </span>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-600 text-yellow-100">
                                <i class="fas fa-clock mr-1"></i>
                                å¾…å®¡æ ¸
                            </span>
                            <span class="text-xs text-yellow-300 bg-yellow-800 px-2 py-0.5 rounded">
                                è¯¾ç¨‹: ${item.courseName}
                            </span>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-yellow-400">ä½œè€…: ${item.authorName}</div>
                            <div class="text-xs text-yellow-600">${timeAgo}</div>
                        </div>
                    </div>
                    
                    ${isPost ? `
                        <h3 class="text-lg font-semibold text-white mb-2">${this.escapeHtml(item.title)}</h3>
                    ` : `
                        <div class="mb-2">
                            <p class="text-sm text-gray-300">æ‰€å±å¸–å­: 
                                <span class="text-white font-medium">"${this.escapeHtml(item.postTitle)}"</span>
                            </p>
                        </div>
                    `}
                    
                    <div class="bg-yellow-800 rounded p-3 mb-3">
                        <p class="text-gray-200 text-sm leading-relaxed">${this.escapeHtml(item.content)}</p>
                    </div>
                    
                    <div class="flex justify-end space-x-2 pt-2 border-t border-yellow-700">
                        <button class="review-approve bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors"
                                data-type="${item.type}"
                                data-id="${item.id}"
                                data-post-id="${item.postId || ''}">
                            <i class="fas fa-check mr-1"></i>é€šè¿‡
                        </button>
                        <button class="review-reject bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm font-medium transition-colors"
                                data-type="${item.type}"
                                data-id="${item.id}"
                                data-post-id="${item.postId || ''}">
                            <i class="fas fa-times mr-1"></i>æ‹’ç»
                        </button>
                    </div>
                `;
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                itemDiv.querySelector('.review-approve').addEventListener('click', (e) => {
                    this.handleReviewAction(e, 'approve');
                });
                
                itemDiv.querySelector('.review-reject').addEventListener('click', (e) => {
                    this.handleReviewAction(e, 'reject');
                });
                
                return itemDiv;
            }

            createPostElement(post) {
                const isAnon = post.visibility === 'Anonymous';
                const displayName = isAnon ? 'åŒ¿åç”¨æˆ·' : post.author_name;
                const isVoted = post.user_voted || false;
                const votes = post.vote_count || 0;
                
                const postDiv = document.createElement('div');
                postDiv.className = 'p-4 bg-gray-700 rounded-lg shadow-md border-l-4 border-blue-500';
                
                let iconClass = 'fas fa-question-circle';
                let colorClass = 'border-blue-500';

                if (post.type === 'Material') {
                    iconClass = 'fas fa-book-open';
                    colorClass = 'border-green-500';
                    postDiv.className = `p-4 bg-gray-700 rounded-lg shadow-md border-l-4 ${colorClass}`;
                } else if (post.type === 'Announcement') {
                     iconClass = 'fas fa-bullhorn';
                     colorClass = 'border-yellow-500';
                     postDiv.className = `p-4 bg-gray-700 rounded-lg shadow-md border-l-4 ${colorClass}`;
                } else {
                     postDiv.className = `p-4 bg-gray-700 rounded-lg shadow-md border-l-4 ${colorClass}`;
                }

                // å…³é”®ä¿®å¤ï¼šæ·»åŠ å®¡æ ¸çŠ¶æ€æ˜¾ç¤º
                const statusBadge = post.status === 'PendingReview' ? 
                    `<span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-yellow-500 text-white ml-2">
                        <i class="fas fa-clock mr-1"></i>å®¡æ ¸ä¸­
                    </span>` : '';

                postDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center">
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${post.type === 'Question' ? 'bg-blue-500' : post.type === 'Material' ? 'bg-green-500' : 'bg-yellow-500'} text-white">
                                <i class="${iconClass} mr-1"></i> ${post.type === 'Question' ? 'é—®é¢˜' : post.type === 'Material' ? 'èµ„æ–™' : 'å…¬å‘Š'}
                            </span>
                            ${statusBadge}
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-400">${isAnon ? '<i class="fas fa-mask mr-1"></i>åŒ¿å' : displayName}</span>
                            ${this.app.isTA ? `
                                <button data-post-id="${post.id}" data-course-id="${post.course_id}" class="delete-post-button text-red-400 hover:text-red-300 text-sm" title="åˆ é™¤å¸–å­">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">${post.title}</h3>
                    <p class="text-gray-300 post-content mb-3">${post.content}</p>
                    
                    ${post.file_name ? `
                        <div class="mt-2 p-2 bg-gray-600 rounded flex items-center justify-between">
                            <span class="text-sm text-blue-300"><i class="fas fa-file-alt mr-2"></i>é™„ä»¶: ${post.file_name}</span>
                            <a href="${this.API_BASE_URL}/files/download/${post.file_path}" target="_blank" class="text-blue-300 hover:text-blue-200 text-sm font-medium"><i class="fas fa-download"></i> ä¸‹è½½</a>
                        </div>
                    ` : ''}

                    <div class="flex items-center justify-between mt-3 pt-2 border-t border-gray-600">
                        <button data-post-id="${post.id}" data-course-id="${post.course_id}" class="vote-button text-sm font-medium transition-colors duration-150 ${isVoted ? 'text-blue-400' : 'text-gray-400 hover:text-blue-300'}">
                            <i class="fas fa-arrow-up mr-1"></i> èµ (${votes})
                        </button>
                        <button data-post-id="${post.id}" class="comment-button text-sm text-gray-400 hover:text-white transition-colors duration-150">
                             <i class="fas fa-reply mr-1"></i> å›ç­”/è¯„è®º
                        </button>
                    </div>
                    <div id="comments-${post.id}" class="mt-4 pt-3 space-y-3">
                        <!-- è¯„è®ºå°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                `;
                
                // å…³é”®ä¿®å¤ï¼šå¦‚æœæ˜¯å®¡æ ¸ä¸­çš„å¸–å­ï¼Œç¦ç”¨äº’åŠ¨åŠŸèƒ½
                if (post.status === 'PendingReview' && !this.app.isTA) {
                    const voteButton = postDiv.querySelector('.vote-button');
                    const commentButton = postDiv.querySelector('.comment-button');
                    if (voteButton) {
                        voteButton.disabled = true;
                        voteButton.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                    if (commentButton) {
                        commentButton.disabled = true;
                        commentButton.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                } else {
                    postDiv.querySelector('.vote-button').addEventListener('click', (e) => this.handleVote(e));
                    postDiv.querySelector('.comment-button').addEventListener('click', () => this.showCommentInput(post.id));
                }
                
                // ä¸ºåŠ©æ•™æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
                if (this.app.isTA) {
                    postDiv.querySelector('.delete-post-button').addEventListener('click', (e) => this.handleDeletePost(e));
                }

                return postDiv;
            }

            setupEventListeners() {
                // æ ‡ç­¾é¡µåˆ‡æ¢
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        this.app.currentTab = e.currentTarget.dataset.tab;
                        console.log(`ğŸ”„ åˆ‡æ¢æ ‡ç­¾é¡µ: ${this.app.currentTab}`);
                        this.renderApp();
                    });
                });

                // åŒ¿åå‘å¸ƒå¼€å…³
                this.anonToggle.addEventListener('change', () => {
                    this.app.isAnonPosting = this.anonToggle.checked;
                    this.renderApp();
                });
                
                // è¯¾ç¨‹é€‰æ‹©å˜æ›´ - å…³é”®ä¿®å¤
                this.courseSelectEl.addEventListener('change', (e) => {
                    const newCourseId = parseInt(e.target.value);
                    console.log(`ğŸ”„ è¯¾ç¨‹åˆ‡æ¢: ${this.app.activeCourseId} -> ${newCourseId}`);
                    
                    if (newCourseId && newCourseId !== this.app.activeCourseId) {
                        this.app.activeCourseId = newCourseId;
                        
                        // é‡æ–°åŠ è½½å¸–å­å’Œæ›´æ–°UI
                        this.loadPosts().then(() => {
                            console.log(`âœ… è¯¾ç¨‹åˆ‡æ¢å®Œæˆï¼Œé‡æ–°æ¸²æŸ“ç•Œé¢`);
                            this.renderApp();
                        }).catch(error => {
                            console.error('âŒ è¯¾ç¨‹åˆ‡æ¢å¤±è´¥:', error);
                        });
                    }
                });                
                
                // å¸–å­ç­›é€‰
                document.getElementById('post-filter').addEventListener('change', () => {
                     this.app.postFilter = document.getElementById('post-filter').value;
                     console.log(`ğŸ”„ å¸–å­ç­›é€‰: ${this.app.postFilter}`);
                     this.loadPosts();
                });
                
                // ç™»å½•/ç™»å‡º
                document.getElementById('login-form').addEventListener('submit', (e) => this.handleLogin(e));
                this.signOutButton.addEventListener('click', () => this.handleSignOut());
                document.getElementById('password-form').addEventListener('submit', (e) => this.handlePasswordUpdate(e));

                // å¸–å­æ¨¡æ€æ¡†æ§åˆ¶ - è®¨è®ºåŒº (é»˜è®¤ä¸ºé—®é¢˜)
                this.showForumPostModalEl.addEventListener('click', () => {
                    document.getElementById('post-type').value = 'Question';
                    document.getElementById('post-title').value = '';
                    document.getElementById('post-content-input').value = '';
                    document.getElementById('file-upload').value = '';
                    document.getElementById('post-error-message').classList.add('hidden');
                    this.postModalEl.classList.remove('hidden');
                    this.renderApp();
                });
                
                // å¸–å­æ¨¡æ€æ¡†æ§åˆ¶ - èµ„æ–™åº“ (é»˜è®¤ä¸ºèµ„æ–™ï¼Œä»…é™åŠ©æ•™)
                this.showRepoPostModalEl.addEventListener('click', () => {
                    document.getElementById('post-type').value = 'Material';
                    document.getElementById('post-title').value = '';
                    document.getElementById('post-content-input').value = '';
                    document.getElementById('file-upload').value = '';
                    document.getElementById('post-error-message').classList.add('hidden');
                    this.postModalEl.classList.remove('hidden');
                    this.renderApp();
                });
                
                document.getElementById('cancel-post-modal').addEventListener('click', () => {
                    this.postModalEl.classList.add('hidden');
                });
                
                // è¯¾ç¨‹æ¨¡æ€æ¡†æ§åˆ¶
                this.showNewCourseModalEl.addEventListener('click', () => {
                    document.getElementById('course-name-input').value = '';
                    document.getElementById('course-description-input').value = '';
                    document.getElementById('course-error-message').classList.add('hidden');
                    this.newCourseModalEl.classList.remove('hidden');
                });
                document.getElementById('cancel-new-course-modal').addEventListener('click', () => {
                    this.newCourseModalEl.classList.add('hidden');
                });
                document.getElementById('new-course-form').addEventListener('submit', (e) => this.handleNewCourse(e));

                // è¯„è®ºæ¨¡æ€æ¡†æ§åˆ¶
                document.getElementById('cancel-comment-modal').addEventListener('click', () => {
                    this.commentModalEl.classList.add('hidden');
                });

                // å¸–å­ç±»å‹å˜æ›´ (æ˜¾ç¤º/éšè—æ–‡ä»¶ä¸Šä¼ )
                this.postTypeSelect.addEventListener('change', () => this.renderApp());

                // ä¸ªäººèµ„æ–™è¡¨å•
                document.getElementById('profile-form').addEventListener('submit', (e) => this.handleProfileUpdate(e));
                
                // æ–°å¸–å­æäº¤
                document.getElementById('new-post-form').addEventListener('submit', (e) => this.handleNewPost(e));
                
                // æ–°è¯„è®ºæäº¤
                document.getElementById('new-comment-form').addEventListener('submit', (e) => this.handleNewComment(e));
            }

            async handleLogin(e) {
                e.preventDefault();
                const loginButton = document.getElementById('login-button');
                const errorMsgEl = document.getElementById('login-error-message');
                
                const userId = document.getElementById('login-id').value.trim();
                const password = document.getElementById('login-password').value.trim();
                
                loginButton.disabled = true;
                loginButton.innerHTML = '<div class="spinner"></div> ç™»å½•ä¸­...';
                errorMsgEl.classList.add('hidden');

                try {
                    await this.login(userId, password);
                } catch (error) {
                    errorMsgEl.textContent = error.message;
                    errorMsgEl.classList.remove('hidden');
                } finally {
                    loginButton.disabled = false;
                    loginButton.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i> ç™»å½•';
                }
            }

            async handleSignOut() {
                try {
                    await this.apiCall('/auth/logout', { method: 'POST' });
                } catch (error) {
                    console.error('âŒ ç™»å‡ºé”™è¯¯:', error);
                } finally {
                    this.logout();
                }
            }
            
            async handlePasswordUpdate(e) {
                e.preventDefault();
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const passwordMsgEl = document.getElementById('password-message');
                const updateButton = document.getElementById('update-password-button');
                
                passwordMsgEl.classList.add('hidden');
                passwordMsgEl.classList.remove('text-green-400', 'text-red-400');
                
                if (newPassword.length < 6) {
                     passwordMsgEl.textContent = "å¯†ç å¿…é¡»è‡³å°‘6ä½ã€‚";
                     passwordMsgEl.classList.add('text-red-400', 'block');
                     return;
                }

                if (newPassword !== confirmPassword) {
                    passwordMsgEl.textContent = "æ–°å¯†ç ä¸åŒ¹é…ã€‚";
                    passwordMsgEl.classList.add('text-red-400', 'block');
                    return;
                }
                
                updateButton.disabled = true;
                updateButton.innerHTML = '<div class="spinner border-t-white border-red-400"></div> æ›´æ–°ä¸­...';

                try {
                    await this.apiCall('/auth/password', {
                        method: 'PUT',
                        body: JSON.stringify({ currentPassword, newPassword })
                    });
                    
                    passwordMsgEl.textContent = "å¯†ç æ›´æ–°æˆåŠŸï¼è¯·è®°ä½æ‚¨çš„æ–°å¯†ç ã€‚";
                    passwordMsgEl.classList.add('text-green-400', 'block');
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                    
                } catch (error) {
                    console.error("âŒ å¯†ç æ›´æ–°é”™è¯¯:", error);
                    passwordMsgEl.textContent = `å¯†ç æ›´æ–°å¤±è´¥: ${error.message}`;
                    passwordMsgEl.classList.add('text-red-400', 'block');
                } finally {
                     updateButton.disabled = false;
                     updateButton.innerHTML = 'æ›´æ–°å¯†ç ';
                }
            }

            async handleNewCourse(e) {
                e.preventDefault();
                if (!this.app.isTA) return;
                
                const courseName = document.getElementById('course-name-input').value.trim();
                const courseDescription = document.getElementById('course-description-input').value.trim();
                const submitButton = document.getElementById('submit-course-button');
                const errorMsgEl = document.getElementById('course-error-message');
                
                submitButton.disabled = true;
                submitButton.innerHTML = '<div class="spinner border-t-white border-purple-400"></div> åˆ›å»ºä¸­...';
                errorMsgEl.classList.add('hidden');
                
                try {
                    const data = await this.apiCall('/courses', {
                        method: 'POST',
                        body: JSON.stringify({ 
                            name: courseName,
                            description: courseDescription
                        })
                    });
                    
                    // è‡ªåŠ¨å°†æ–°è¯¾ç¨‹è®¾ä¸ºæ´»è·ƒè¯¾ç¨‹
                    this.app.activeCourseId = data.course.id;
                    
                    // é‡æ–°åŠ è½½è¯¾ç¨‹åˆ—è¡¨å’Œå¸–å­
                    await this.loadInitialData();
                    
                    this.newCourseModalEl.classList.add('hidden');
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    this.showSuccessMessage(`è¯¾ç¨‹ "${courseName}" åˆ›å»ºæˆåŠŸï¼`);
                    
                } catch (error) {
                    console.error("âŒ åˆ›å»ºæ–°è¯¾ç¨‹é”™è¯¯:", error);
                    errorMsgEl.textContent = error.message;
                    errorMsgEl.classList.remove('hidden');
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'åˆ›å»ºè¯¾ç¨‹';
                }
            }

            showSuccessMessage(message) {
                // åˆ›å»ºä¸´æ—¶æˆåŠŸæ¶ˆæ¯
                const successEl = document.createElement('div');
                successEl.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-transform duration-300';
                successEl.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-check-circle mr-2"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(successEl);
                
                // 3ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    successEl.remove();
                }, 3000);
            }

            showCommentInput(postId) {
                document.getElementById('comment-post-id').value = postId;
                document.getElementById('comment-content-input').value = '';
                document.getElementById('comment-error-message').classList.add('hidden');
                this.commentModalEl.classList.remove('hidden');
            }

            async handleNewComment(e) {
                e.preventDefault();
                if (!this.app.activeCourseId) return;

                const submitButton = document.getElementById('submit-comment-button');
                const errorMsgEl = document.getElementById('comment-error-message');
                
                submitButton.disabled = true;
                submitButton.innerHTML = '<div class="spinner border-t-white border-blue-400"></div> æäº¤ä¸­...';
                errorMsgEl.classList.add('hidden');

                const postId = document.getElementById('comment-post-id').value;
                const content = document.getElementById('comment-content-input').value.trim();
                
                // æå‰éªŒè¯å†…å®¹æ˜¯å¦ä¸ºç©º
                if (!content) {
                    errorMsgEl.textContent = "è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©ºã€‚";
                    errorMsgEl.classList.remove('hidden');
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'æäº¤ç­”æ¡ˆ';
                    return;
                }
                
                try {
                    // å…³é”®ä¿®å¤ï¼šè°ƒç”¨AIå†…å®¹å®¡æ ¸
                    const moderationStatus = await this.checkContentWithAI(content);
                    
                    const responseData = await this.apiCall('/comments', {
                        method: 'POST',
                        body: JSON.stringify({
                            postId,
                            content,
                            visibility: this.app.isAnonPosting ? 'Anonymous' : 'Public'
                        })
                    });

                    this.commentModalEl.classList.add('hidden');
                    
                    // å…³é”®ä¿®å¤ï¼šæ ¹æ®å®¡æ ¸çŠ¶æ€ç»™ç”¨æˆ·åé¦ˆ
                    if (responseData.status === 'PendingReview') {
                        this.showSuccessMessage('è¯„è®ºå·²æäº¤å®¡æ ¸ï¼å®¡æ ¸é€šè¿‡åå°†å¯¹å…¶ä»–ç”¨æˆ·å¯è§ã€‚');
                    } else {
                        this.showSuccessMessage('è¯„è®ºå‘å¸ƒæˆåŠŸï¼');
                    }
                    
                    // é‡æ–°åŠ è½½è¯„è®º
                    await this.loadComments(postId, this.app.activeCourseId);
                    
                } catch (error) {
                    console.error("âŒ åˆ›å»ºæ–°è¯„è®ºé”™è¯¯:", error);
                    errorMsgEl.textContent = error.message;
                    errorMsgEl.classList.remove('hidden');
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'æäº¤ç­”æ¡ˆ';
                }
            }

            async handleVote(e) {
                const postId = e.currentTarget.dataset.postId;
                const courseId = e.currentTarget.dataset.courseId;
                
                try {
                    await this.apiCall(`/posts/${postId}/vote`, {
                        method: 'POST'
                    });
                    
                    // é‡æ–°åŠ è½½å¸–å­ä»¥æ›´æ–°æŠ•ç¥¨çŠ¶æ€
                    await this.loadPosts();
                    
                } catch (error) {
                    console.error("âŒ æŠ•ç¥¨å¤±è´¥:", error);
                    this.showError('æŠ•ç¥¨å¤±è´¥: ' + error.message);
                }
            }
            
            async handleDeletePost(e) {
                if (!this.app.isTA) return;
                
                const postId = e.currentTarget.dataset.postId;
                const courseId = e.currentTarget.dataset.courseId;
                
                try {
                    if (confirm("ç¡®å®šè¦åˆ é™¤æ­¤å¸–å­å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚")) {
                        await this.apiCall(`/posts/${postId}`, {
                            method: 'DELETE'
                        });
                        
                        // é‡æ–°åŠ è½½å¸–å­
                        await this.loadPosts();
                    }
                } catch (error) {
                    console.error("âŒ åˆ é™¤å¸–å­é”™è¯¯:", error);
                    this.showError('åˆ é™¤å¸–å­å¤±è´¥: ' + error.message);
                }
            }

            async handleDeleteComment(e) {
                if (!this.app.isTA) return;
                
                const postId = e.currentTarget.dataset.postId;
                const commentId = e.currentTarget.dataset.commentId;
                const courseId = e.currentTarget.dataset.courseId;
                
                try {
                    if (confirm("ç¡®å®šè¦åˆ é™¤æ­¤è¯„è®ºå—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚")) {
                        await this.apiCall(`/comments/${commentId}`, {
                            method: 'DELETE'
                        });
                        
                        // é‡æ–°åŠ è½½è¯„è®º
                        await this.loadComments(postId, courseId);
                    }
                } catch (error) {
                    console.error("âŒ åˆ é™¤è¯„è®ºé”™è¯¯:", error);
                    this.showError('åˆ é™¤è¯„è®ºå¤±è´¥: ' + error.message);
                }
            }

            /**
             * å¤„ç†å®¡æ ¸æ“ä½œ
             */
            async handleReviewAction(e, action) {
                const button = e.currentTarget;
                const itemType = button.dataset.type;
                const itemId = button.dataset.id;
                const postId = button.dataset.postId;
                
                const confirmMessage = action === 'approve' 
                    ? `ç¡®å®šè¦é€šè¿‡æ­¤${itemType === 'post' ? 'å¸–å­' : 'è¯„è®º'}å—ï¼Ÿ` 
                    : `ç¡®å®šè¦æ‹’ç»æ­¤${itemType === 'post' ? 'å¸–å­' : 'è¯„è®º'}å—ï¼Ÿ`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
                
                // ç¦ç”¨æŒ‰é’®
                button.disabled = true;
                button.innerHTML = `<div class="spinner"></div> å¤„ç†ä¸­...`;
                
                try {
                    const endpoint = itemType === 'post' 
                        ? `/posts/${itemId}/moderate`
                        : `/comments/${itemId}/moderate`;
                    
                    const data = await this.apiCall(endpoint, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: action,
                            reason: 'å†…å®¹å®¡æ ¸'
                        })
                    });
                    
                    if (data.success) {
                        // ä»DOMä¸­ç§»é™¤å·²å®¡æ ¸çš„é¡¹ç›®
                        const itemElement = button.closest('.bg-yellow-900');
                        if (itemElement) {
                            itemElement.remove();
                        }
                        
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        this.showSuccessMessage(data.message);
                        
                        // å¦‚æœå®¡æ ¸é˜Ÿåˆ—ä¸ºç©ºï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                        if (this.reviewListEl.children.length === 0) {
                            this.renderReviewQueue([], []);
                        }
                    }
                } catch (error) {
                    console.error('âŒ å®¡æ ¸æ“ä½œå¤±è´¥:', error);
                    this.showError('å®¡æ ¸æ“ä½œå¤±è´¥: ' + error.message);
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    button.disabled = false;
                    button.innerHTML = action === 'approve' 
                        ? '<i class="fas fa-check mr-1"></i>é€šè¿‡' 
                        : '<i class="fas fa-times mr-1"></i>æ‹’ç»';
                }
            }

            /**
             * è°ƒç”¨AIå†…å®¹å®¡æ ¸
             */
            async checkContentWithAI(content) {
                try {
                    const response = await fetch(`${this.API_BASE_URL}/moderate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.app.token}`
                        },
                        body: JSON.stringify({ content })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`å®¡æ ¸APIè°ƒç”¨å¤±è´¥: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return result.status;
                } catch (error) {
                    console.error('âŒ AIå®¡æ ¸è°ƒç”¨å¤±è´¥:', error);
                    return 'PendingReview';
                }
            }

            async handleNewPost(e) {
                e.preventDefault();
                if (!this.app.activeCourseId) return;
                
                const submitButton = document.getElementById('submit-post-button');
                const errorMsgEl = document.getElementById('post-error-message');
                
                submitButton.disabled = true;
                submitButton.innerHTML = '<div class="spinner border-t-white border-blue-400"></div> å‘å¸ƒä¸­...';
                errorMsgEl.classList.add('hidden');
                
                try {
                    const title = document.getElementById('post-title').value.trim();
                    const content = document.getElementById('post-content-input').value.trim();
                    const postType = this.postTypeSelect.value;
                    const fileInput = document.getElementById('file-upload');
                    const file = fileInput.files[0];
                    
                    // éªŒè¯å¿…å¡«å­—æ®µ
                    if (!title || !content) {
                        throw new Error("æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©ºã€‚");
                    }
                    
                    if ((postType === 'Announcement' || postType === 'Material') && !this.app.isTA) {
                        throw new Error(`åªæœ‰åŠ©æ•™å¯ä»¥å‘å¸ƒ${postType === 'Announcement' ? 'å…¬å‘Š' : 'èµ„æ–™'}å¸–å­ã€‚`);
                    }

                    // å…³é”®ä¿®å¤ï¼šè°ƒç”¨AIå†…å®¹å®¡æ ¸
                    const moderationStatus = await this.checkContentWithAI(title + "\n\n" + content);
                    
                    // æ„å»ºè¯·æ±‚æ•°æ®ï¼ŒåŒ…å«å®¡æ ¸çŠ¶æ€
                    const postData = {
                        courseId: this.app.activeCourseId,
                        title: title,
                        content: content,
                        type: postType,
                        visibility: this.app.isAnonPosting ? 'Anonymous' : 'Public'
                    };

                    let responseData;
                    
                    if (postType === 'Material' && file) {
                        // å¯¹äºæ–‡ä»¶ä¸Šä¼ ï¼Œä½¿ç”¨ FormData
                        const formData = new FormData();
                        formData.append('courseId', this.app.activeCourseId);
                        formData.append('title', title);
                        formData.append('content', content);
                        formData.append('type', postType);
                        formData.append('visibility', this.app.isAnonPosting ? 'Anonymous' : 'Public');
                        formData.append('file', file);

                        const response = await fetch(`${this.API_BASE_URL}/posts`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${this.app.token}`
                            },
                            body: formData
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'å‘å¸ƒå¤±è´¥');
                        }

                        responseData = await response.json();
                    } else {
                        // å¯¹äºæ²¡æœ‰æ–‡ä»¶çš„å¸–å­ï¼Œä½¿ç”¨ JSON æ ¼å¼
                        responseData = await this.apiCall('/posts', {
                            method: 'POST',
                            body: JSON.stringify(postData)
                        });
                    }

                    this.postModalEl.classList.add('hidden');

                    // å…³é”®ä¿®å¤ï¼šæ ¹æ®å®¡æ ¸çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„æ¶ˆæ¯
                    if (responseData.status === 'PendingReview') {
                        this.showSuccessMessage('å¸–å­å·²æäº¤å®¡æ ¸ï¼å®¡æ ¸é€šè¿‡åå°†å¯¹å…¶ä»–ç”¨æˆ·å¯è§ã€‚');
                    } else {
                        this.showSuccessMessage('å¸–å­å‘å¸ƒæˆåŠŸï¼');
                    }

                    // é‡æ–°åŠ è½½å¸–å­
                    await this.loadPosts();

                } catch (error) {
                    console.error("âŒ åˆ›å»ºæ–°å¸–å­é”™è¯¯:", error);
                    errorMsgEl.textContent = error.message;
                    errorMsgEl.classList.remove('hidden');
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'å‘å¸ƒ';
                }
            }

            async handleProfileUpdate(e) {
                e.preventDefault();
                const newName = document.getElementById('display-name').value.trim();
                if (!newName) return;
                
                try {
                    await this.apiCall('/auth/profile', {
                        method: 'PUT',
                        body: JSON.stringify({ displayName: newName })
                    });
                    
                    this.app.user.displayName = newName;
                    
                    e.target.querySelector('button').textContent = "å·²ä¿å­˜!";
                    this.renderApp();
                    
                    setTimeout(() => {
                         e.target.querySelector('button').textContent = "ä¿å­˜æ˜¾ç¤ºåç§°";
                    }, 2000);
                } catch (error) {
                    console.error("âŒ æ›´æ–°ä¸ªäººèµ„æ–™é”™è¯¯:", error);
                    e.target.querySelector('button').textContent = "ä¿å­˜å¤±è´¥";
                }
            }

            showAppContent() {
                this.loginScreenEl.classList.add('hidden');
                this.initialLoadingEl.classList.add('hidden');
                this.appContentEl.classList.remove('hidden');
                this.renderApp();
            }

            showLoginScreen() {
                this.initialLoadingEl.classList.add('hidden');
                this.appContentEl.classList.add('hidden');
                this.loginScreenEl.classList.remove('hidden');
                this.renderApp();
            }

            showError(message) {
                this.errorMessageEl.textContent = message;
                this.initialErrorEl.classList.remove('hidden');
            }

            /**
             * å·¥å…·å‡½æ•°ï¼šè½¬ä¹‰HTML
             */
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            /**
             * å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ—¶é—´
             */
            formatTimeAgo(timestamp) {
                const now = new Date();
                const time = new Date(timestamp);
                const diff = now - time;
                
                const minute = 60 * 1000;
                const hour = 60 * minute;
                const day = 24 * hour;
                
                if (diff < minute) {
                    return 'åˆšåˆš';
                } else if (diff < hour) {
                    return `${Math.floor(diff / minute)}åˆ†é’Ÿå‰`;
                } else if (diff < day) {
                    return `${Math.floor(diff / hour)}å°æ—¶å‰`;
                } else {
                    return `${Math.floor(diff / day)}å¤©å‰`;
                }
            }
        }

        // å¯åŠ¨åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            window.physicsHubApp = new PhysicsHubApp();
        });
    </script>
</body>
</html>